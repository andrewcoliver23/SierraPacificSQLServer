WITH Sub1_VINTAGE_EOM AS (
SELECT Sub1.Loan.MspLastRunDate, Sub1.Loan.LoanNumber, OriginalLoan.OldLoanNumberFormatted AS SPMLoan$, CAST(FirstPrincipalBalance AS MONEY) AS FirstPrincipalBalance, Sub1.Loan.LoanReoStatusCode, Sub1.Loan.PaymentInFullStopCode, LoanClosingDate as FundingDate,
Sub1.Property.PropertyAlphaStateCode as PropertyState, Sub1.Loan.InvestorId, Sub1.Loan.ForeclosureStatusCode, Sub1.Loan.HiType, Sub1.Loan.LoType
FROM Sub1.Loan INNER JOIN Sub1.Property ON Sub1.Loan.MspLastRunDate = Sub1.Property.MspLastRunDate AND Sub1.Loan.LoanNumber = Sub1.Property.LoanNumber
INNER JOIN SUB1.OriginalLoan ON Property.LoanNumber = OriginalLoan.LoanNumber and Property.MspLastRunDate = OriginalLoan.MspLastRunDate
WHERE Loan.MspLastRunDate = '2022-10-31' AND CAST(FirstPrincipalBalance AS MONEY) > 1 AND Sub1.Loan.LoanReoStatusCode <> 'A' AND Sub1.Loan.PaymentInFullStopCode <> '1' AND Sub1.Loan.InvestorId <> 'ACT'),

SUB2_VINTAGE_EOM AS (
SELECT LOAN.DATA_ASOF_DATE as MspLastRundate, LOAN.LOAN_NBR_SERVICER as LoanNumber, LOAN.LOAN_NBR_OTHERFormatted AS SPMLoan$, Cast(PRIN_BALANCE_CURR AS MONEY) AS FirstPrincipalBalance, LOAN.LOAN_REO_STATUS_CODE as LoanReoStatuscode, 
LOAN.PAYOFF_TYPE,LOAN_CLOSING_DATE as FundingDate, SUB2.Property.PROP_STATE as PropertyState, LOAN.INV_CODE AS InvestorId, 
SUB2.Foreclosure.FCL_STATUS as ForeclosureStatusCode, LOAN.LIEN_POSITION as HiType, LOAN.LOAN_TYPE as LoType
FROM SUB2.Loan INNER JOIN SUB2.Property ON LOAN.DATA_ASOF_DATE = Property.DATA_ASOF_DATE AND LOAN.LOAN_NBR_SERVICER = Property.LOAN_NBR_SERVICER 
LEFT JOIN SUB2.Foreclosure ON SUB2.Property.DATA_ASOF_DATE = SUB2.Foreclosure.DATA_ASOF_DATE AND SUB2.Property.LOAN_NBR_SERVICER = SUB2.Foreclosure.LOAN_NBR_SERVICER
WHERE Loan.DATA_ASOF_DATE= '2022-10-31' AND Cast(PRIN_BALANCE_CURR AS money) > 1 AND LOAN.LOAN_REO_STATUS_CODE<> 'A'  AND LOAN.INV_CODE Not In ('1S1','47Y','ACT','4C9','30M')),

VINTAGE_DATA_EOM AS (
select * from Sub1_VINTAGE_EOM
UNION
select * from SUB2_VINTAGE_EOM),

Sub1_VINTAGE AS (
SELECT Sub1.Loan.MspLastRunDate, Sub1.Loan.LoanNumber,OriginalLoan.OldLoanNumberFormatted AS SPMLoan#, CAST(FirstPrincipalBalance AS MONEY) AS FirstPrincipalBalance, Sub1.Loan.LoanReoStatusCode, Sub1.Loan.PaymentInFullStopCode, LoanClosingDate as FundingDate,
Sub1.Property.PropertyAlphaStateCode as PropertyState, Sub1.Loan.InvestorId, Sub1.Loan.ForeclosureStatusCode, Sub1.Loan.HiType, Sub1.Loan.LoType
FROM Sub1.Loan INNER JOIN Sub1.Property ON Sub1.Loan.MspLastRunDate = Sub1.Property.MspLastRunDate AND Sub1.Loan.LoanNumber = Sub1.Property.LoanNumber
INNER JOIN SUB1.OriginalLoan ON Property.LoanNumber = OriginalLoan.LoanNumber and Property.MspLastRunDate = OriginalLoan.MspLastRunDate
WHERE Loan.MspLastRunDate = '2022-11-30' AND CAST(FirstPrincipalBalance AS MONEY) > 1 AND Sub1.Loan.LoanReoStatusCode <> 'A' AND Sub1.Loan.PaymentInFullStopCode <> '1' AND Sub1.Loan.InvestorId <> 'ACT'),

SUB2_VINTAGE AS (
SELECT LOAN.DATA_ASOF_DATE as MspLastRundate, LOAN.LOAN_NBR_SERVICER as LoanNumber, LOAN.LOAN_NBR_OTHERFormatted AS SPMLoan#, Cast(PRIN_BALANCE_CURR AS MONEY) AS FirstPrincipalBalance, LOAN.LOAN_REO_STATUS_CODE as LoanReoStatuscode, 
LOAN.PAYOFF_TYPE,LOAN_CLOSING_DATE as FundingDate, SUB2.Property.PROP_STATE as PropertyState, LOAN.INV_CODE AS InvestorId, 
SUB2.Foreclosure.FCL_STATUS as ForeclosureStatusCode, LOAN.LIEN_POSITION as HiType, LOAN.LOAN_TYPE as LoType
FROM SUB2.Loan INNER JOIN SUB2.Property ON LOAN.DATA_ASOF_DATE = Property.DATA_ASOF_DATE AND LOAN.LOAN_NBR_SERVICER = Property.LOAN_NBR_SERVICER 
LEFT JOIN SUB2.Foreclosure ON SUB2.Property.DATA_ASOF_DATE = SUB2.Foreclosure.DATA_ASOF_DATE AND SUB2.Property.LOAN_NBR_SERVICER = SUB2.Foreclosure.LOAN_NBR_SERVICER
WHERE LOAN.DATA_ASOF_DATE= '2022-11-30' AND Cast(PRIN_BALANCE_CURR AS money) > 1 AND LOAN.LOAN_REO_STATUS_CODE<> 'A'  AND LOAN.INV_CODE Not In ('1S1','47Y','ACT','4C9','30M')),

VINTAGE_DATA_TABLE AS (								   
select * from Sub1_VINTAGE
UNION
select * from SUB2_VINTAGE)

SELECT VINTAGE_DATA_TABLE.*, (SELECT MIN(E.MspLastRunDate) FROM VINTAGE_DATA_EOM E)	as LastFileDate
FROM VINTAGE_DATA_TABLE LEFT JOIN [SPM.ExemptLoans] E on VINTAGE_DATA_TABLE.LoanNumber = E.LoanNumber
LEFT JOIN VINTAGE_DATA_EOM ON VINTAGE_DATA_TABLE.LoanNumber = VINTAGE_DATA_EOM.LoanNumber
WHERE VINTAGE_DATA_EOM.LoanNumber is null and e.loannumber is null

